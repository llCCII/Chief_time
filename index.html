<!DOCTYPE html>
<html>

<head>
    <title>倒计时任务识别工具</title>
    <script src="https://unpkg.com/tesseract.js@v3.0.3/dist/tesseract.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.29.4/moment.min.js"></script>
    <style>
        /* 添加加载动画 */
        .loader {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #3498db;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            animation: spin 1s linear infinite;
            margin: 20px auto;
            display: none;
        }

        @keyframes spin {
            0% {
                transform: rotate(0deg);
            }

            100% {
                transform: rotate(360deg);
            }
        }

        #result {
            margin-top: 20px;
        }

        table {
            border-collapse: collapse;
            width: 100%;
        }

        th,
        td {
            padding: 8px;
            border: 1px solid #ddd;
            text-align: left;
        }
    </style>
</head>

<body>
    <h2>上传任务截图：</h2>
    <input type="file" id="upload" accept="image/*">
    <div class="loader" id="loader"></div>
    <div id="result"></div>

    <script>
        const worker = Tesseract.createWorker({
            logger: m => console.log(m)
        });

        // 初始化 OCR 引擎
        (async () => {
            try {
                await worker.load();
                await worker.loadLanguage('chi_sim+eng');
                await worker.initialize('chi_sim+eng');
                console.log('OCR引擎初始化完成');
            } catch (error) {
                showError('OCR引擎初始化失败: ' + error.message);
            }
        })();

        // 处理图片上传
        document.getElementById('upload').addEventListener('change', async (e) => {
            const file = e.target.files[0];
            if (!file) return;

            // 显示加载动画
            showLoading(true);
            clearResult();

            try {
                // 创建临时图片预览
                const imageUrl = URL.createObjectURL(file);
                const img = await loadImage(imageUrl);
                URL.revokeObjectURL(imageUrl); // 释放内存

                // 识别文字（含位置信息）
                console.log('开始识别...');
                const { data: { lines } } = await worker.recognize(img, {
                    rectangle: {
                        top: 0,
                        left: 0,
                        width: img.width,
                        height: img.height
                    }
                });

                // 解析结果并渲染
                const results = parseOCRResults(lines);
                if (results.length > 0) {
                    renderResults(results);
                } else {
                    showError('未检测到有效的时间格式（xx时xx分）');
                }
            } catch (error) {
                showError('识别失败: ' + error.message);
            } finally {
                showLoading(false);
            }
        });

        // 辅助函数：加载图片
        function loadImage(url) {
            return new Promise((resolve, reject) => {
                const img = new Image();
                img.onload = () => resolve(img);
                img.onerror = (e) => reject(new Error('图片加载失败'));
                img.src = url;
            });
        }

        // 解析逻辑（增强版）
        function parseOCRResults(lines) {
            const timePattern = /(\d+)\s*时\s*(\d+)\s*分/;
            const results = [];

            lines.forEach((line, index) => {
                const text = line.text.replace(/\s+/g, ''); // 去除空格干扰
                const match = timePattern.exec(text);
                if (match) {
                    const hours = parseInt(match[1]), minutes = parseInt(match[2]);
                    const taskLine = findNearestTaskLine(lines, index);
                    results.push({
                        task: taskLine?.text || "未命名任务",
                        time: `${hours}时${minutes}分`,
                        dueTime: moment().add(hours, 'h').add(minutes, 'm').format('YYYY-MM-DD HH:mm')
                    });
                }
            });
            return results;
        }

        // 增强版任务名匹配（考虑垂直和水平位置）
        function findNearestTaskLine(lines, currentIndex) {
            const currentLine = lines[currentIndex];
            let closestLine = null;
            let minDistance = Infinity;

            for (let i = currentIndex - 1; i >= 0; i--) {
                const line = lines[i];
                // 计算垂直距离（当前行顶部 - 候选行底部）
                const verticalDist = currentLine.bbox.y0 - line.bbox.y1;
                // 水平重叠检测
                const horizontalOverlap =
                    (line.bbox.x0 < currentLine.bbox.x1) &&
                    (line.bbox.x1 > currentLine.bbox.x0);

                if (verticalDist > 0 && verticalDist < 100 && horizontalOverlap) {
                    if (verticalDist < minDistance) {
                        minDistance = verticalDist;
                        closestLine = line;
                    }
                }
            }
            return closestLine;
        }

        // 界面交互函数
        function showLoading(show) {
            document.getElementById('loader').style.display = show ? 'block' : 'none';
        }

        function renderResults(results) {
            const html = `
                <h3>识别结果：</h3>
                <table>
                    <tr><th>任务名</th><th>任务时间</th><th>预计完成时间</th></tr>
                    ${results.map(item => `
                        <tr>
                            <td>${item.task}</td>
                            <td>${item.time}</td>
                            <td>${item.dueTime}</td>
                        </tr>
                    `).join('')}
                </table>
            `;
            document.getElementById('result').innerHTML = html;
        }

        function showError(message) {
            document.getElementById('result').innerHTML = `
                <div style="color: red; padding: 10px; border: 1px solid red;">
                    ${message}
                </div>
            `;
        }

        function clearResult() {
            document.getElementById('result').innerHTML = '';
        }
    </script>
</body>

</html>